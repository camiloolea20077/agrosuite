<!-- inventory-management.component.html -->
<div class="inventory-management">
  <!-- Header -->
  <div class="card">
    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4">
      <div class="flex align-items-center mb-3 md:mb-0">
        <i class="pi pi-database mr-2 text-2xl text-primary"></i>
        <h2 class="text-2xl font-bold m-0">Gestión de Inventario</h2>
      </div>
      
      <div class="flex gap-2">
        <p-button 
          label="Nuevo Insumo"
          icon="pi pi-plus"
          class="p-button-primary"
          (onClick)="showAddDialog()">
        </p-button>
      </div>
    </div>

    <!-- Search and filters -->
    <div class="flex flex-column md:flex-row gap-3 mb-4">
      <div class="flex-1">
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input 
            pInputText 
            type="text" 
            placeholder="Buscar insumos..." 
            class="w-full"
            [(ngModel)]="globalFilterValue"
            (input)="onGlobalFilter($event)">
        </span>
      </div>
      
      <p-button 
        icon="pi pi-filter-slash"
        class="p-button-outlined"
        pTooltip="Limpiar filtros"
        (onClick)="clear()">
      </p-button>
    </div>

    <!-- Inventory Table -->
    <p-table 
      [value]="inventory"
      [loading]="isLoading"
      [paginator]="false"
      [responsive]="true"
      (onLazyLoad)="loadTable($event)"
      styleClass="p-datatable-gridlines p-datatable-striped"
      [tableStyle]="{ 'min-width': '80rem' }">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <span class="font-semibold">#</span>
          </th>
          <th pSortableColumn="nombre_insumo" style="min-width: 15rem">
            <div class="flex align-items-center">
              <span class="font-semibold">Nombre del Insumo</span>
              <p-sortIcon field="nombre_insumo"></p-sortIcon>
            </div>
          </th>
          <th style="min-width: 10rem">
            <span class="font-semibold">Descripción</span>
          </th>
          <th pSortableColumn="unidad" style="min-width: 8rem">
            <div class="flex align-items-center">
              <span class="font-semibold">Unidad</span>
              <p-sortIcon field="unidad"></p-sortIcon>
            </div>
          </th>
          <th pSortableColumn="stock_actual" style="min-width: 10rem">
            <div class="flex align-items-center">
              <span class="font-semibold">Stock Actual</span>
              <p-sortIcon field="stock_actual"></p-sortIcon>
            </div>
          </th>
          <th style="min-width: 8rem">
            <span class="font-semibold">Estado Stock</span>
          </th>
          <th style="width: 10rem">
            <span class="font-semibold">Acciones</span>
          </th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
        <tr>
          <td>
            <span class="text-sm text-500">{{ first + rowIndex + 1 }}</span>
          </td>
          <td>
            <div class="flex flex-column">
              <span class="font-medium">{{ item.nombre_insumo }}</span>
              <small class="text-500" *ngIf="item.codigo">{{ item.codigo }}</small>
            </div>
          </td>
          <td>
            <span class="text-sm" 
                  [pTooltip]="item.descripcion" 
                  *ngIf="item.descripcion">
              {{ (item.descripcion.length > 50) ? (item.descripcion | slice:0:50) + '...' : item.descripcion }}
            </span>
            <span class="text-500 text-sm" *ngIf="!item.descripcion">Sin descripción</span>
          </td>
          <td>
            <span class="font-medium">{{ item.unidad }}</span>
          </td>
          <td>
            <div class="flex align-items-center">
              <span class="font-bold text-lg mr-2">{{ item.stock_actual }}</span>
              <span class="text-500 text-sm">{{ item.unidad }}</span>
            </div>
          </td>
          <td>
            <p-tag 
              [value]="getStockLabel(item.stock_actual, 10)"
              [severity]="getStockSeverity(item.stock_actual, 10)">
            </p-tag>
          </td>
          <td>
            <div class="flex gap-1">
              <p-button 
                icon="pi pi-eye"
                class="p-button-text p-button-rounded p-button-info"
                size="small"
                pTooltip="Ver detalles"
                (onClick)="showEditDialog(item)">
              </p-button>
              
              <p-button 
                icon="pi pi-pencil"
                class="p-button-text p-button-rounded p-button-warning"
                size="small"
                pTooltip="Editar"
                (onClick)="showEditDialog(item)">
              </p-button>
              
              <p-button 
                icon="pi pi-trash"
                class="p-button-text p-button-rounded p-button-danger"
                size="small"
                pTooltip="Eliminar"
                (onClick)="confirmDelete(item)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center p-4">
            <div class="flex flex-column align-items-center justify-content-center">
              <i class="pi pi-inbox text-4xl text-400 mb-3"></i>
              <span class="text-500 text-lg">No se encontraron insumos</span>
              <small class="text-400">Agrega el primer insumo al inventario</small>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <!-- Pagination -->
    <p-paginator 
      *ngIf="totalRecords > 0"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [first]="first"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
      (onPageChange)="onPageChange($event)">
    </p-paginator>
  </div>

  <!-- Form Dialog -->
  <p-dialog 
    [header]="isEditing ? 'Editar Insumo' : 'Nuevo Insumo'"
    [(visible)]="isFormVisible"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '800px' }"
    [closable]="!isLoading"
    [dismissableMask]="!isLoading"
    styleClass="p-fluid">
    
    <form [formGroup]="inventoryForm" (ngSubmit)="onSubmit()">
      <div class="grid">
        <!-- Información básica -->
        <div class="col-12">
          <h4 class="text-primary mb-3">
            <i class="pi pi-info-circle mr-2"></i>
            Información Básica
          </h4>
        </div>
        
        <div class="col-12 md:col-6">
          <label for="codigoInterno" class="font-semibold">
            Código Interno *
          </label>
          <input 
            id="codigoInterno"
            type="text" 
            pInputText 
            formControlName="codigoInterno"
            [class.ng-invalid]="isFieldInvalid('codigoInterno')"
            placeholder="Ej: INS-001">
          <small class="p-error" *ngIf="isFieldInvalid('codigoInterno')">
            {{ getFieldError('codigoInterno') }}
          </small>
        </div>
        
        <div class="col-12 md:col-6">
          <label for="nombreInsumo" class="font-semibold">
            Nombre del Insumo *
          </label>
          <input 
            id="nombreInsumo"
            type="text" 
            pInputText 
            formControlName="nombreInsumo"
            [class.ng-invalid]="isFieldInvalid('nombreInsumo')"
            placeholder="Nombre del insumo">
          <small class="p-error" *ngIf="isFieldInvalid('nombreInsumo')">
            {{ getFieldError('nombreInsumo') }}
          </small>
        </div>
        
        <div class="col-12 md:col-6">
          <label for="marca" class="font-semibold">Marca</label>
          <input 
            id="marca"
            type="text" 
            pInputText 
            formControlName="marca"
            placeholder="Marca del producto">
        </div>
        
        <div class="col-12 md:col-6">
          <label for="tipoInsumoId" class="font-semibold">
            Tipo de Insumo *
          </label>
          <p-dropdown 
            id="tipoInsumoId"
            formControlName="tipoInsumoId"
            [options]="tiposInsumos"
            optionLabel="nombre"
            optionValue="id"
            [class.ng-invalid]="isFieldInvalid('tipoInsumoId')"
            placeholder="Seleccione un tipo">
          </p-dropdown>
          <small class="p-error" *ngIf="isFieldInvalid('tipoInsumoId')">
            {{ getFieldError('tipoInsumoId') }}
          </small>
        </div>
        
        <div class="col-12">
          <label for="descripcion" class="font-semibold">Descripción</label>
          <textarea 
            id="descripcion"
            pInputTextarea 
            formControlName="descripcion"
            rows="3"
            placeholder="Descripción del insumo">
          </textarea>
        </div>

        <!-- Unidades y conversión -->
        <div class="col-12">
          <h4 class="text-primary mb-3 mt-4">
            <i class="pi pi-calculator mr-2"></i>
            Unidades y Conversión
          </h4>
        </div>
        
        <div class="col-12 md:col-4">
          <label for="unidadMedida" class="font-semibold">
            Unidad de Medida *
          </label>
          <p-dropdown
            id="unidadMedida"
            [options]="unidadesMedida"
            formControlName="unidadMedida"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccione unidad"
            [class.ng-invalid]="isFieldInvalid('unidadMedida')"
            class="w-full"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
          >
          </p-dropdown>

          <small class="p-error" *ngIf="isFieldInvalid('unidadMedida')">
            {{ getFieldError('unidadMedida') }}
          </small>
        </div>
        
        <div class="col-12 md:col-4">
          <label for="unidadCompra" class="font-semibold">
            Unidad de Compra *
          </label>
          <p-dropdown
            id="unidadCompra"
            [options]="unidadesCompra"
            formControlName="unidadCompra"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccione unidad de compra"
            [class.ng-invalid]="isFieldInvalid('unidadCompra')"
            class="w-full"
            [filter]="true"
            filterBy="label"
            [showClear]="true"
          >
          </p-dropdown>

          <small class="p-error" *ngIf="isFieldInvalid('unidadCompra')">
            {{ getFieldError('unidadCompra') }}
          </small>
        </div>
        
        <div class="col-12 md:col-4">
          <label for="factorConversion" class="font-semibold">
            Factor de Conversión *
          </label>
          <p-inputNumber 
            id="factorConversion"
            formControlName="factorConversion"
            [class.ng-invalid]="isFieldInvalid('factorConversion')"
            mode="decimal"
            [minFractionDigits]="2"
            [maxFractionDigits]="4"
            placeholder="1.0000">
          </p-inputNumber>
          <small class="p-error" *ngIf="isFieldInvalid('factorConversion')">
            {{ getFieldError('factorConversion') }}
          </small>
        </div>

        <!-- Cantidades -->
        <div class="col-12">
          <h4 class="text-primary mb-3 mt-4">
            <i class="pi pi-chart-bar mr-2"></i>
            Control de Stock
          </h4>
        </div>
        
        <div class="col-12 md:col-3">
          <label for="cantidadActual" class="font-semibold">
            Cantidad Actual *
          </label>
          <p-inputNumber 
            id="cantidadActual"
            formControlName="cantidadActual"
            [class.ng-invalid]="isFieldInvalid('cantidadActual')"
            mode="decimal"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            [min]="0">
          </p-inputNumber>
          <small class="p-error" *ngIf="isFieldInvalid('cantidadActual')">
            {{ getFieldError('cantidadActual') }}
          </small>
        </div>
        
        <div class="col-12 md:col-3">
          <label for="cantidadMinima" class="font-semibold">
            Cantidad Mínima *
          </label>
          <p-inputNumber 
            id="cantidadMinima"
            formControlName="cantidadMinima"
            [class.ng-invalid]="isFieldInvalid('cantidadMinima')"
            mode="decimal"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            [min]="0">
          </p-inputNumber>
          <small class="p-error" *ngIf="isFieldInvalid('cantidadMinima')">
            {{ getFieldError('cantidadMinima') }}
          </small>
        </div>
        
        <div class="col-12 md:col-3">
          <label for="puntoReorden" class="font-semibold">
            Punto de Reorden *
          </label>
          <p-inputNumber 
            id="puntoReorden"
            formControlName="puntoReorden"
            [class.ng-invalid]="isFieldInvalid('puntoReorden')"
            mode="decimal"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            [min]="0">
          </p-inputNumber>
          <small class="p-error" *ngIf="isFieldInvalid('puntoReorden')">
            {{ getFieldError('puntoReorden') }}
          </small>
        </div>
        
        <div class="col-12 md:col-3">
          <label for="cantidadReservada" class="font-semibold">
            Cantidad Reservada
          </label>
          <p-inputNumber 
            id="cantidadReservada"
            formControlName="cantidadReservada"
            mode="decimal"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            [min]="0">
          </p-inputNumber>
        </div>

        <!-- Ubicación y características -->
        <div class="col-12">
          <h4 class="text-primary mb-3 mt-4">
            <i class="pi pi-map-marker mr-2"></i>
            Ubicación y Características
          </h4>
        </div>
        
        <div class="col-12 md:col-6">
          <label for="ubicacionAlmacen" class="font-semibold">
            Ubicación en Almacén
          </label>
          <input 
            id="ubicacionAlmacen"
            type="text" 
            pInputText 
            formControlName="ubicacionAlmacen"
            placeholder="Ej: Estante A, Nivel 2">
        </div>
        
        <div class="col-12 md:col-6">
          <label for="estadoId" class="font-semibold">
            Estado *
          </label>
          <p-dropdown 
            id="estadoId"
            formControlName="estadoId"
            [options]="estadosInventario"
            optionLabel="nombre"
            optionValue="id"
            [class.ng-invalid]="isFieldInvalid('estadoId')"
            placeholder="Seleccione un estado">
          </p-dropdown>
          <small class="p-error" *ngIf="isFieldInvalid('estadoId')">
            {{ getFieldError('estadoId') }}
          </small>
        </div>
        
        <div class="col-12 md:col-6">
          <div class="field-checkbox">
            <p-checkbox 
              id="esPeligroso"
              formControlName="esPeligroso"
              [binary]="true">
            </p-checkbox>
            <label for="esPeligroso" class="ml-2">
              <i class="pi pi-exclamation-triangle text-orange-500 mr-1"></i>
              Es peligroso
            </label>
          </div>
        </div>
        
        <div class="col-12 md:col-6">
          <div class="field-checkbox">
            <p-checkbox 
              id="requiereCuidadoEspecial"
              formControlName="requiereCuidadoEspecial"
              [binary]="false">
            </p-checkbox>
            <label for="requiereCuidadoEspecial" class="ml-2">
              <i class="pi pi-shield text-blue-500 mr-1"></i>
              Requiere cuidado especial
            </label>
          </div>
        </div>
        <div class="col-12">
          <label for="notas" class="font-semibold">Notas</label>
          <textarea 
            id="notas"
            pInputTextarea 
            formControlName="notas"
            rows="3"
            placeholder="Notas adicionales sobre el insumo">
          </textarea>
        </div>
      </div>
    </form>
    
    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2">
        <p-button 
          label="Cancelar"
          icon="pi pi-times"
          class="p-button-text"
          [disabled]="isLoading"
          (onClick)="hideDialog()">
        </p-button>
        
        <p-button 
          [label]="isEditing ? 'Actualizar' : 'Crear'"
          icon="pi pi-check"
          class="p-button-primary"
          [loading]="isLoading"
          [disabled]="inventoryForm.invalid"
          (onClick)="onSubmit()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Toast Messages -->
  <p-toast position="top-right" [life]="5000"></p-toast>
  
  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
  
  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-content">
      <p-progressSpinner></p-progressSpinner>
      <p>Procesando...</p>
    </div>
  </div>
</div>